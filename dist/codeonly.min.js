function e(e){let t,r="^",n=e.length;for(let s=0;s<n;s++){t=!0;let a=e[s];if("?"==a)r+="[^\\/]";else if("*"==a)r+=s+1==n?"(?<tail>.*)":"[^\\/]+";else if(":"==a){s++;let a=s;for(;s<n&&i(e[s]);)s++;let o=e.substring(a,s);if(0==o.length)throw new Error("syntax error in url pattern: expected id after ':'");let h="[^\\/]+";if("("==e[s]){s++,a=s;let t=0;for(;s<n;){if("("==e[s])t++;else if(")"==e[s]){if(0==t)break;t--}s++}if(s>=n)throw new Error("syntax error in url pattern: expected ')'");h=e.substring(a,s),s++}if(s<n&&"*"==e[s]||"+"==e[s]){let n=e[s];s++,"/"==e[s]?(r+=`(?<${o}>(?:${h}\\/)${n})`,s++):r+="*"==n?`(?<${o}>(?:${h}\\/)*(?:${h})?\\/?)`:`(?<${o}>(?:${h}\\/)*(?:${h})\\/?)`,t=!1}else r+=`(?<${o}>${h})`;s--}else"/"==a?(r+="\\"+a,s==e.length-1&&(r+="?")):".$^{}[]()|*+?\\/".indexOf(a)>=0?(r+="\\"+a,t="/"!=a):r+=a}return t&&(r+="\\/?"),r+="$",r;function i(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"==e||"$"==e}}class t{constructor(e){this.#e=Object.assign({max:10},e)}#t=[];#e;get(e,t){e instanceof URL&&(e=e.pathname+e.query);for(let t=0;t<this.#t.length;t++){let r=this.#t[t];if(r.key==e)return t>0&&(this.#t.splice(t,1),this.#t.unshift(r)),r.page}let r={key:e,page:t(e)};return this.#t.unshift(r),this.#t.length>this.#e.max&&this.#t.splice(this.#t),r.page}}class r{static get(){return{top:coenv.window.pageYOffset||coenv.document.documentElement.scrollTop,left:coenv.window.pageXOffset||coenv.document.documentElement.scrollLeft}}static set(e){e?coenv.window.scrollTo(e.left,e.top):coenv.window.scrollTo(0,0)}}let n=[],i=!1;class s{constructor(e){this.#r=e,coenv.window.history.scrollRestoration&&(coenv.window.history.scrollRestoration="manual");let t=coenv.window.sessionStorage.getItem("codeonly-view-states");t&&(this.#n=JSON.parse(t)),e.addEventListener("mayLeave",((e,t)=>(this.captureViewState(),!0))),e.addEventListener("mayEnter",((e,t)=>{"push"!=t.navMode&&(t.viewState=this.#n[t.state.sequence])})),e.addEventListener("didEnter",((e,t)=>{if("push"==t.navMode){for(let e of Object.keys(this.#n))parseInt(e)>t.state.sequence&&delete this.#n[e];this.saveViewStates()}var s,a;s=coenv,a=()=>{var e,s;(e=()=>{t.handler.restoreViewState?t.handler.restoreViewState(t.viewState,t):this.#r.restoreViewState?this.#r.restoreViewState?.(t.viewState,t):r.set(t.viewState);{let e=document.getElementById(t.url.hash.substring(1));e?.scrollIntoView()}})&&(0!=(s=s??0)&&(i=!0),n.push({callback:e,order:s}),1==n.length&&coenv.window.requestAnimationFrame((function(){let e=n;i&&(e.sort(((e,t)=>t.order-e.order)),i=!1),n=[];for(let t=e.length-1;t>=0;t--)e[t].callback()})))},s.loading?s.addEventListener("loaded",a,{once:!0}):a()})),coenv.window.addEventListener("beforeunload",(e=>{this.captureViewState()}))}#r;#n={};captureViewState(){let e=this.#r.current;e&&(e.handler.captureViewState?this.#n[e.state.sequence]=e.handler.captureViewState(e):this.#r.captureViewState?this.#n[e.state.sequence]=this.#r.captureViewState?.(e):this.#n[e.state.sequence]=r.get()),this.saveViewStates()}saveViewStates(){coenv.window.sessionStorage.setItem("codeonly-view-states",JSON.stringify(this.#n))}}class a{async start(e){this.#r=e,new s(e),coenv.document.body.addEventListener("click",(e=>{if(e.defaultPrevented)return;let t=e.target.closest("a");if(t){if(t.hasAttribute("download"))return;let r=t.getAttribute("href"),n=new URL(r,coenv.window.location);if(n.origin==coenv.window.location.origin){try{n=this.#r.internalize(n)}catch{return}return this.navigate(n).then((e=>{null==e&&(window.location.href=r)})),e.preventDefault(),!0}}})),coenv.window.addEventListener("popstate",(async e=>{if(this.#i)return void(this.#i=!1);let t=this.#s+1,r=this.#r.internalize(new URL(coenv.window.location)),n=e.state??{sequence:this.current.state.sequence+1};await this.load(r,n,{navMode:"pop"})||t==this.#s&&(this.#i=!0,coenv.window.history.go(this.current.state.sequence-n.sequence))}));let t=this.#r.internalize(new URL(coenv.window.location)),r=coenv.window.history.state??{sequence:0},n=await this.load(t,r,{navMode:"start"});return coenv.window.history.replaceState(r,null),n}#s=0;#r;#i=!1;get current(){return this.#r.current}async load(e,t,r){return this.#s++,await this.#r.load(e,t,r)}back(){if(0==this.current.state.sequence){let e=new URL("/",this.#r.internalize(new URL(coenv.window.location))),t={sequence:0};coenv.window.history.replaceState(t,"",this.#r.externalize(e)),this.load(e,t,{navMode:"replace"})}else coenv.window.history.back()}replace(e){"string"==typeof e&&(e=new URL(e,this.#r.internalize(new URL(coenv.window.location)))),void 0!==e&&(this.current.pathname=e.pathname,this.current.url=e,e=this.#r.externalize(e).href),coenv.window.history.replaceState(this.current.state,"",e)}async navigate(e){"string"==typeof e&&(e=new URL(e,this.#r.internalize(new URL(coenv.window.location))));let t=await this.load(e,{sequence:this.current.state.sequence+1},{navMode:"push"});return t?(coenv.window.history.pushState(t.state,"",this.#r.externalize(e)),t):t}}class o{constructor(e){e&&this.register(e)}start(e){if(!this.#a)return e||(e=new a),this.#a=e,e&&(this.navigate=e.navigate.bind(e),this.replace=e.replace.bind(e),this.back=e.back.bind(e)),this.#a.start(this)}#a;#o(e,t){return this.urlMapper?e instanceof URL?this.urlMapper[t](e):this.urlMapper[t](new URL(e,"http://x/")).href.substring(8):e instanceof URL?new URL(e):e}urlMapper;internalize(e){return this.#o(e,"internalize")}externalize(e){return this.#o(e,"externalize")}#h={c:null,p:null,l:[]};get#c(){return this.#a?.state??this.#h}get#l(){return this.#c.c}set#l(e){this.#c.c=e}get#u(){return this.#c.p}set#u(e){this.#c.p=e}get#d(){return this.#c.l}get current(){return this.#l}get pending(){return this.#u}addEventListener(e,t){this.#d.push({event:e,handler:t})}removeEventListener(e,t){let r=this.#d.findIndex((r=>r.event==e&&r.handler==t));r>=0&&this.#d.splice(r,1)}async dispatchEvent(e,t,r,n){for(let i of this.#d)if(i.event==e){let e=i.handler(r,n);if(t&&0==await Promise.resolve(e))return!1}return!0}async load(e,t,r){return coenv.load((async()=>{r=r??{};let n=this.#l;if(this.#l?.url.pathname==e.pathname&&this.#l.url.search==e.search){let e=this.#l.handler.hashChange?.(this.#l,r);r=void 0!==e?e:Object.assign({},this.#l,r)}if(r=Object.assign(r,{current:!1,url:new URL(e),state:t}),this.#u=r,!r.match&&!(r=await this.matchUrl(e,t,r)))return null;try{!0!==await this.tryLoad(r)&&(this.#u=null)}catch(e){throw this.dispatchCancelEvents(n,r),e}return this.#u!=r?(this.dispatchCancelEvents(n,r),null):(this.#u=null,r)}))}dispatchCancelEvents(e,t){this.#l?.handler.cancelLeave?.(e,t),t.handler.cancelEnter?.(e,t),this.dispatchEvent("cancel",!1,e,t)}async tryLoad(e){let t,r=this.#l;if(r){if(!await this.dispatchEvent("mayLeave",!0,r,e))return;if(e!=this.#u)return;if(t=r.handler.mayLeave?.(r,e),!1===await Promise.resolve(t))return;if(e!=this.#u)return}if(t=e.handler.mayEnter?.(r,e),!1!==await Promise.resolve(t)&&e==this.#u&&await this.dispatchEvent("mayEnter",!0,r,e)&&e==this.#u)return r&&(r.current=!1),e.current=!0,this.#l=e,r&&(this.dispatchEvent("didLeave",!1,r,e),r?.handler.didLeave?.(r,e)),e.handler.didEnter?.(r,e),this.dispatchEvent("didEnter",!1,r,e),!0}async matchUrl(e,t,r){this.#w&&(this.#p.sort(((e,t)=>(e.order??0)-(t.order??0))),this.#w=!1);for(let e of this.#p)if(!e.pattern||(r.match=r.url.pathname.match(e.pattern),r.match)){if(!e.match)return r.handler=e,r;{let t=await Promise.resolve(e.match(r));if(!0===t||t==r)return r.handler=e,r;if(null===t)return null}}return r.handler={},r}#p=[];#w=!1;register(t){Array.isArray(t)||(t=[t]);for(let r of t)"string"==typeof r.pattern&&(r.pattern=new RegExp(e(r.pattern))),this.#p.push(r);this.#w=!0}revoke(e){this.#p=this.#p.filter((t=>!e(t)))}captureViewState;restoreViewState}let h=new o;class c{constructor(e){if(this.options=e,this.options.base&&(!this.options.base.startsWith("/")||!this.options.base.endsWith("/")))throw new Error(`UrlMapper base '${this.options.base}' must start and end with '/'`)}internalize(e){if(this.options.base){if(!e.pathname.startsWith(this.options.base))throw new Error(`Can't internalize url '${e}'`);(e=new URL(e)).pathname=e.pathname.substring(this.options.base.length-1)}if(this.options.hash){if("/"!=e.pathname)throw new Error(`can't internalize url "${e.href}"`);let t=e.hash.substring(1);t.startsWith("/")||(t="/"+t),e=new URL(`${e.origin}${t}`)}return e}externalize(e,t){return!t&&this.options.hash&&(e=new URL(`${e.origin}/#${e.pathname}${e.search}${e.hash}`)),this.options.base&&((e=new URL(e)).pathname=this.options.base.slice(0,-1)+e.pathname),e}}async function l(e){if(!e.startsWith("/"))throw new Error("asset paths must start with '/'");if(h.urlMapper){let t=new URL(e,new URL(coenv.window.location));t=h.urlMapper.externalize(t,!0),e=t.pathname+t.search}return coenv.fetchTextAsset(e)}async function u(e){return JSON.parse(await l(e))}export{r as DocumentScrollPosition,t as PageCache,o as Router,c as UrlMapper,s as ViewStateRestoration,a as WebHistoryRouterDriver,u as fetchJsonAsset,l as fetchTextAsset,h as router,e as urlPattern};
